{% extends "base.html" %}
{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='main.css/home.css')}}">
<link rel="stylesheet" href="{{ url_for('static', filename='main.css/base_page.css')}}">

{% endblock%}
{% block title %}StoryLab{% endblock %}

{% block content %}

<!-- Темы -->
{% block themes %}
    <div class="container_list_themes">
        <nav>
            <ul class="ul_list-theme">
               <li><a class="all_themes" href="/world">&equiv; Все темы</a></li>
               <li><a class="theme_list" href="/topic/travel">Путешествия</a></li>
               <li><a class="theme_list" href="/topic/technologies">Технологии</a></li>
                <li><a class="theme_list" href="/topic/games">Гейминг</a></li>
               <li><a class="theme_list" href="/about">Наука</a></li>
               <li><a class="theme_list" href="/about">Искусство</a></li>
               <li><a class="theme_list" href="/about">Спорт</a></li>
               <li><a class="theme_list" href="/about">Кулинария</a></li>
               <li><a class="theme_list" href="/about">Здоровье</a></li>
               <li><a class="theme_list" href="/about">Образование</a></li>
               <li><a class="theme_list" href="/about">Развлечения</a></li>
            </ul>
        </nav>

    </div>
{% endblock %}


<!--Первый контейнер-->

{#<div class="container_content1">#}
{#    <div class="container_content1_image"><img src="{{ url_for('static', filename='background-image.jpg') }}"></div>#}
{#    <div class="container_content1_left">#}
{#        <h1>Откройте любимую тему и узнайте что-то новое</h1>#}
{#    </div>#}
{#</div>#}
{##}
{#<!--О популярных постах-->#}
{#<div class="about_popular_posts">#}
{#    <h1>Популярное в StoryLab</h1>#}
{#    <hr>#}
{#</div>#}

<!--Три популярных поста-->

<!--<div class="first_posts">-->
<!--    <div class="container_content2">-->
<!--    <a>container_content2</a>-->
<!--    </div>-->

<!--    <div class="container_content3">-->
<!--    <a>container_content3</a>-->
<!--    </div>-->

<!--    <div class="container_content4">-->
<!--    <a>container_content4</a>-->
<!--    </div>-->
<!--</div>-->

<!--Популярные посты-->

<div class="container_body">
   <div class="container_popular_posts">
    <div class="popular_posts">

            {% if posts %} <!-- если постов нет, показывает сообщение -->
            {% for post in posts %} <!-- Добавлен цикл для перебора всех постов -->

        <div id="post-{{ post.id }}" class="post-card">
        <article class="post-card__article">
        <a class="post-card__link" href="{{ url_for('view_post', post_id=post.id) }}" rel="opener dofollow" aria-label="Читать пост '{{ post.title }}'"></a>

        <!-- Блок изображения -->
        <div class="post-card__image">
            {% set first_img_src = extract_first_image(post.content) %}
            {% if first_img_src %}
                <img src="{{ first_img_src }}" alt="{{ post.title }}" loading="lazy"/>
            {% else %}
                <div class="post-card__image-placeholder"></div>
            {% endif %}
        </div>

        <!-- Информация о пользователе -->
        <div class="post-card__user">
            <div class="post-card__user-avatar"></div>
            <div class="post-card__user-info">
                <p class="post-card__username">{{ post.user.blogname }}</p>
                <time class="post-card__date" datetime="{{ post.created_at.isoformat() }}">
                    {{ post.created_at.strftime('%d.%m.%Y %H:%M') }}
                </time>
            </div>
        </div>

        <!-- Контент поста -->
        <div class="post-card__content">
            <h2 class="post-card__title">{{ post.title[:65] }}{% if post.title|length > 50 %}...{% endif %}</h2>
            <div class="post-card__excerpt">
                {{ post.content|striptags|truncate(100) }}
            </div>
        </div>

        <!-- Футер поста -->
        <footer class="post-card__footer">
            <form action="/toggle_like/{{ post.id }}" method="POST" class="post-card__action">
                <button type="submit" class="post-card__action--like" aria-label="Лайкнуть пост">
                    <img src="{{ url_for('static', filename='like_post.png') }}" alt="" aria-hidden="true">
                </button>
            </form>
            <p>{{ Like.query.filter_by(post_id=post.id).count() }}</p>
            <a href="{{ url_for('view_post', post_id=post.id) }}#comments" class="post-card__action post-card__action--comment" aria-label="Комментировать пост">
                <img class="comment_post" src="{{ url_for('static', filename='comment.png') }}" alt="Коммент">
            </a>
            <p>{{ Comment.query.filter_by(post_id=post.id).count() }}</p>
        </footer>
    </article>
</div>
            {% endfor %}
    {% else %}
        <p>Пока нет постов. <a href="{{ url_for('create_post') }}">Создайте первый!</a></p>
            {% endif %}

    </div>
</div>


<!--Липкий контейнер-->

<div class="container_sticky">
    {% if not current_user.is_authenticated %}
    <div class="create_account">
        <a class="create_register" href={{ url_for('register') }}></a>

        <div class="create_account_image">
            <img src="{{ url_for('static', filename='cat_is_writing.jpg') }}" alt="Коммент">
        </div>

        <div class="create_account_text">
            <h1>Создайте аккаунт на WorldBlog!</h1>
            <a>Читайте интересные статьи, знакомьтесь с последними новостями или публикуйте собственные посты</a>
        </div>
    </div>
    {% endif %}
<!--    Недавние посты-->
    <div class="new_posts_h1">
        <h1>Недавние посты</h1>
    </div>
    <hr class = hr_container_sticky>

<!--    Список постов-->
    {% if latest_posts %}
        {% for post in latest_posts %}
            <div class="resent_post1">

                    <!-- Новый блок для изображения -->
            <div class="resent-image_post">
                {% set first_img_src = extract_first_image(post.content) %}
                {% if first_img_src %}
                    <img src="{{ first_img_src }}" alt="Пост"/>
                {% endif %}
                    </div>

        <div class="resent_post1_name_post">
            <h3>{{ post.title[:25] }}{% if post.content|length > 100 %}...{% endif %}</h3>
            <p class="post-date">{{ post.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
            <p class="post-preview">{{ post.content[:60] | safe}}{% if post.content|length > 100 %}...{% endif %}</p>
             <a href="{{ url_for('view_post', post_id=post.id) }}" target="_blank" class="read-more">Читать далее</a>
            </div>
        </div>
            <hr class = hr_container_sticky>
        {% endfor %}
    {% endif %}
    </div>

</div>
{% endblock %}